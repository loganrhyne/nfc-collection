<!DOCTYPE html>
<html>
<head>
    <title>LED Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(15, 30px);
            gap: 2px;
            margin: 20px 0;
        }
        .led {
            width: 30px;
            height: 30px;
            background-color: #333;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .led.active {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .controls {
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LED Integration Test</h1>
        
        <div id="status" class="status disconnected">Disconnected</div>
        
        <h2>LED Grid (10x15)</h2>
        <div id="grid" class="grid"></div>
        
        <div class="controls">
            <button onclick="clearAll()">Clear All</button>
            <button onclick="testPattern()">Test Pattern</button>
            <button onclick="simulateEntry(5, '#E6C200')">Select Beach Entry (5)</button>
            <button onclick="simulateEntry(15, '#E67300')">Select Desert Entry (15)</button>
            <button onclick="simulateEntry(null)">Clear Selection</button>
        </div>
        
        <h3>Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io('http://localhost:8765');
        const grid = document.getElementById('grid');
        const status = document.getElementById('status');
        const log = document.getElementById('log');
        
        const leds = [];
        
        // Initialize grid
        for (let i = 0; i < 150; i++) {
            const led = document.createElement('div');
            led.className = 'led';
            led.id = `led-${i}`;
            led.onclick = () => selectLED(i);
            grid.appendChild(led);
            leds.push(led);
        }
        
        // Socket.IO events
        socket.on('connect', () => {
            status.textContent = 'Connected';
            status.className = 'status connected';
            addLog('Connected to server');
        });
        
        socket.on('disconnect', () => {
            status.textContent = 'Disconnected';
            status.className = 'status disconnected';
            addLog('Disconnected from server');
        });
        
        socket.on('led_status', (data) => {
            addLog(`LED Status: ${JSON.stringify(data)}`);
            updateGrid(data.status);
        });
        
        // Functions
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function updateGrid(status) {
            // Clear all LEDs first
            leds.forEach(led => {
                led.style.backgroundColor = '#333';
                led.classList.remove('active');
            });
            
            // Highlight selected LED
            if (status.selected_index !== null && status.selected_index < leds.length) {
                leds[status.selected_index].classList.add('active');
            }
        }
        
        function selectLED(index) {
            socket.emit('led_update', {
                command: 'set_selected',
                index: index,
                color: '#FFFFFF'
            });
            addLog(`Selected LED ${index}`);
        }
        
        function clearAll() {
            socket.emit('led_update', {
                command: 'clear_all'
            });
            addLog('Cleared all LEDs');
        }
        
        function testPattern() {
            const colors = ['#E6C200', '#E67300', '#00B3B3', '#996633', '#0099FF'];
            const entries = [];
            
            for (let i = 0; i < 20; i++) {
                entries.push({
                    index: Math.floor(Math.random() * 150),
                    color: colors[Math.floor(Math.random() * colors.length)],
                    brightness: 0.5
                });
            }
            
            socket.emit('led_update', {
                command: 'update_entries',
                entries: entries
            });
            addLog(`Test pattern: ${entries.length} random entries`);
        }
        
        function simulateEntry(index, color) {
            if (index === null) {
                socket.emit('led_update', {
                    command: 'set_selected',
                    index: null
                });
                addLog('Cleared selection');
            } else {
                socket.emit('led_update', {
                    command: 'set_selected',
                    index: index,
                    color: color
                });
                addLog(`Selected entry ${index} with color ${color}`);
                
                // Update visual
                leds.forEach((led, i) => {
                    led.style.backgroundColor = '#333';
                    led.classList.remove('active');
                });
                if (index < leds.length) {
                    leds[index].style.backgroundColor = color;
                    leds[index].classList.add('active');
                }
            }
        }
    </script>
</body>
</html>